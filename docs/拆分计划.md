# ESXi-Mate 独立开源拆分计划
新项目的位置是：/root/ESXi-Mate/


## 1. 项目目标
将 `opsnav` 项目中核心的 **ESXi 主机管理** 与 **虚拟机管理** 功能剥离，构建为一个独立、轻量、可直接运行的开源项目 `ESXi-Mate`。

## 1.1 兼容性与测试范围
当前已验证的版本为 **VMware ESXi 7.0.0**。其他 ESXi 版本以及 vCenter 兼容性**暂未测试，不做保证**。

## 1.2 主体功能范围 (MVP)
必须可用的主体功能如下：
1. ESXi 主机纳管/探测、主机列表与排序、主机同步。
2. 虚拟机列表、虚拟机电源操作（开机/关机/重启等）。
3. 虚拟机克隆。
4. VMware Tools 安装（通过任务中心异步执行）。

## 1.3 端口规划
为避免与现有 `opsnav` 服务冲突，ESXi-Mate 默认端口规划如下：
- 后端 API: **9601**
- 前端 Web: **9528**

## 2. 迁移策略
采用 **“最小化复制 + 清洗”** 的策略。不直接复制整个 Git 历史，而是将相关联的代码文件、依赖配置、数据库结构复制到新仓库，并剔除与 ESXi 无关的业务逻辑（如原有的鉴权、其他云纳管、CI/CD 模块等）。

## 3. 待迁移文件清单

### 3.1 后端 (Backend)
**核心服务与API:**
*   `backend/app/api/virtualization.py` -> 核心 API 接口
*   `backend/app/services/virtualization_service.py` -> 核心业务逻辑 (pyVmomi 交互)
*   `backend/app/models/virtualization.py` -> 数据库模型 (EsxiHost, VirtualMachine)
*   `backend/app/schemas/virtualization.py` -> Pydantic 校验模型

**基础架构 (需精简/修改):**
*   `backend/main.py` -> 入口文件 (需重写，只保留 virtualization 路由)
*   `backend/app/db/database.py` -> 数据库连接 (需保留)
*   `backend/app/core/config.py` -> 配置管理 (需保留)
*   `backend/app/core/security.py` -> (可选) 如果开源版需要简单鉴权，需保留或简化
*   `backend/app/api/__init__.py` -> 路由注册
*   `backend/app/services/task_service.py` -> 异步任务支持 (如克隆/安装Tools需要)
*   `backend/app/models/task.py` -> 任务模型

**配置与依赖:**
*   `backend/requirements.txt` -> 需精简，主要保留 `fastapi`, `sqlalchemy`, `pyvmomi`, `pydantic` 等。
*   `backend/.env.example` -> 需针对 ESXi-Mate 定制。

### 3.2 前端 (Frontend)
**页面与组件:**
*   `frontend/src/pages/Virtualization/` -> 包含 `Hosts.tsx`, `Instances.tsx`, `Dashboard.tsx` 等所有核心页面。
*   `frontend/src/api/virtualization.ts` -> API 定义。
*   `frontend/src/api/tasks.ts` -> 任务中心 API。
*   `frontend/src/components/TaskCenter.tsx` -> 任务中心组件。
*   `frontend/src/components/monitor/` -> 监控表格组件 (MonitorTableFrame, MonitorToolbar)。

**基础架构 (需适配):**
*   `frontend/src/App.tsx` & `router.tsx` -> 路由配置 (需重写，作为独立 App 的根路由)。
*   `frontend/src/components/Layout.tsx` -> 侧边栏/顶栏 (需简化，只保留 ESXi 相关菜单)。
*   `frontend/package.json` -> 依赖管理。
*   `frontend/vite.config.ts` -> 构建配置。

### 3.3 数据库与脚本
*   `database/init_database.sql` -> 提取 `esxi_hosts`, `virtual_machines`, `tasks` 等相关表的建表语句（仅 MySQL 场景需要，SQLite 默认使用 ORM 自动建表）。
*   `scripts/` -> 如果有独立的探测脚本，需一并迁移。

## 4. 执行步骤 (Step-by-Step)

### 第一阶段：后端迁移与独立运行
1.  **初始化后端目录**: 在 `ESXi-Mate` 下创建 `backend` 结构。
2.  **复制核心代码**: 将上述后端文件复制过去。
3.  **依赖清洗**: 创建新的 `requirements.txt`，移除 Ansible、Kubernetes 等无关依赖。
4.  **入口重写**: 创建新的 `backend/main.py`，去除无关 Middleware 和 Router，仅挂载 `virtualization` 和 `task` 模块。
5.  **验证启动**: 确保 `uvicorn main:app` 能成功启动，Swagger 文档可见。

### 第二阶段：前端迁移与适配
1.  **初始化前端目录**: 使用 `npm create vite` 或复制原有 `frontend` 骨架（剔除 `node_modules`）。
2.  **复制页面组件**: 搬运 `pages/Virtualization` 和相关 `components`。
3.  **路由重组**: 修改 `router.tsx`，将 ESXi Dashboard 设为首页。
4.  **菜单精简**: 修改 Sidebar 配置，仅保留 ESXi 相关入口。
5.  **API 联调**: 确保前端能正确调用新的后端地址。

### 第三阶段：文档与工程化
1.  **README.md**: 编写项目介绍、快速启动指南 (Docker Compose / 本地运行)。
2.  **Dockerfile**: 编写前后端 Dockerfile，支持一键部署。
3.  **LICENSE**: 添加开源协议 (如 MIT)。

## 5. 待办事项
- [x] 确认是否需要保留“用户/权限”系统？ -> **已确认：移除**。开源版将设计为单用户/本地版，去除复杂的 RBAC 和 Token 鉴权，降低部署门槛。
- [x] 确认数据库选择 -> **已确认：SQLite**。默认使用 SQLite，零配置启动，无需额外部署 MySQL。

## 6. 特殊处理说明 (基于简化决策)
1.  **移除鉴权依赖**: 修改 `backend/app/api/virtualization.py` 等文件，移除 `get_current_user` 等依赖注入。
2.  **数据库配置**: 修改 `backend/app/db/database.py`，默认连接字符串改为 `sqlite:///./esxi_mate.db`。
3.  **前端适配**: 移除登录页面 (`Login.tsx`) 和 `RequireAuth` 路由守卫，应用启动即进入 Dashboard。
4.  **任务系统保留**: 因主体功能包含 VM 克隆/Tools 安装，需保留 `task_service` 与 `tasks` 相关表结构。

## 7. 开始前准备清单（建议先确认/准备好）

### 7.1 配置与端口
- [ ] 后端默认端口固定为 **9601**（例如通过 `APP_PORT=9601`）。
- [ ] 前端默认端口固定为 **9528**（Vite dev server / 生产环境端口保持一致或可配置）。
- [ ] CORS 允许前端来源（至少包含 `http://localhost:9528`）。
- [ ] 前端 API BaseURL/代理配置指向后端（例如 `http://localhost:9601`）。
- [ ] 提供 `backend/.env.example`（SQLite 默认 + 端口 + ESXi 默认凭据 + CORS）。

### 7.2 数据库与迁移策略（SQLite 默认）
- [ ] SQLite 默认库文件位置（例如 `./esxi_mate.db`）是否可接受：可写权限、备份策略、日志位置。
- [ ] ORM 自动建表策略确认：首次启动自动创建表，后续字段补齐采用“启动时检查并 ALTER”的方式。
- [ ] 若保留 MySQL 兼容：提供 `database/init_database.sql`（可选），并在 README 明确 MySQL 属于可选部署方式。

### 7.3 任务系统（克隆/Tools 必需）
- [ ] 确认任务中心作为必选模块保留（后端 `task_service` + 数据表 + 前端任务中心组件）。
- [ ] 异步任务执行方式确认：FastAPI `BackgroundTasks`（开发/单机可用） vs 独立队列（后续再引入）。

### 7.4 依赖清洗（后端/前端）
- [ ] 后端依赖最小集（建议在 `requirements.txt` 里分层标注“必需/可选”）：
  - 必需：`fastapi`, `uvicorn`, `sqlalchemy`, `pydantic`, `pyvmomi`, `python-dotenv`
  - 可选（与功能绑定）：`requests`（guest file upload）、`paramiko`（SSH 安装 Tools）
- [ ] 前端依赖清理：只保留 Virtualization 页面、任务中心、布局相关依赖，移除非 ESXi 模块。

### 7.5 部署脚手架（建议同步准备）
- [ ] `docker-compose.yml`（一键启动前后端；默认 SQLite，不强制 MySQL）。
- [ ] 后端 `Dockerfile`（包含依赖安装、环境变量、默认启动端口 9601）。
- [ ] 前端 `Dockerfile` 或 Nginx 静态托管方案（端口 9528 或反代到 80）。
- [ ] README：快速启动、本机运行、Docker 部署、已验证 ESXi 7.0.0、其他版本/vCenter 未保证。

## 8. 验收清单（主体功能可用的判定标准）
- [ ] 后端可启动：访问 `http://localhost:9601/api/docs` 可打开 Swagger。
- [ ] 主机纳管：可通过 `POST /api/virtualization/hosts` 探测并保存主机。
- [ ] 主机列表排序：`GET /api/virtualization/hosts` 按 `sort_order` 返回；`POST /api/virtualization/hosts/reorder` 生效。
- [ ] 主机同步：`POST /api/virtualization/sync` 可刷新主机与 VM 数据。
- [ ] VM 列表：`GET /api/virtualization/vms` 可分页/筛选展示。
- [ ] VM 电源：`POST /api/virtualization/vms/{vm_id}/power` 可执行并返回结果。
- [ ] VM 克隆：`POST /api/virtualization/vms/{vm_id}/clone` 能创建任务并后台执行。
- [ ] Tools 安装：`POST /api/virtualization/vms/{vm_id}/install-tools` 能创建任务并后台执行。
